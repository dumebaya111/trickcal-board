<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>트릭컬 보드</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <style>
    .page { display: none; }
    .active { display: table; }
    button { margin: 5px; padding: 8px 12px; }
  </style>
</head>
<body>
  <div>
    <button onclick="showPage(1)">메인시트</button>
    <button onclick="showPage(2)">1관</button>
    <button onclick="showPage(3)">2관</button>
    <button id="btnSave" onclick="saveSQLite()" disabled>저장</button>
    <input type="file" id="fileInput" style="display:none" onchange="loadSQLite(event)">
    <button id="btnLoad" onclick="document.getElementById('fileInput').click()" disabled>불러오기</button>
    <span id="pageIndicator">현재 페이지: 메인시트</span>
  </div>

  <!-- 페이지들 -->
  <table id="page1" class="page active" border="1">
    <thead><tr><th>이름</th><th>선택</th></tr></thead>
    <tbody>
      <tr><td>캐릭터A</td><td><select><option>-</option><option>O</option><option>X</option></select></td></tr>
      <tr><td>캐릭터B</td><td><select><option>-</option><option>O</option><option>X</option></select></td></tr>
    </tbody>
  </table>

  <table id="page2" class="page" border="1">
    <thead><tr><th>이름</th><th>선택</th></tr></thead>
    <tbody>
      <tr><td>캐릭터C</td><td><select><option>-</option><option>O</option><option>X</option></select></td></tr>
      <tr><td>캐릭터D</td><td><select><option>-</option><option>O</option><option>X</option></select></td></tr>
    </tbody>
  </table>

  <table id="page3" class="page" border="1">
    <thead><tr><th>이름</th><th>선택</th></tr></thead>
    <tbody>
      <tr><td>캐릭터E</td><td><select><option>-</option><option>O</option><option>X</option></select></td></tr>
      <tr><td>캐릭터F</td><td><select><option>-</option><option>O</option><option>X</option></select></td></tr>
    </tbody>
  </table>

  <script>
    let db;

    // 페이지 전환
    function showPage(num) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page' + num).classList.add('active');
      document.getElementById('pageIndicator').textContent =
        "현재 페이지: " + (num === 1 ? "메인시트" : (num-1) + "관");
    }

    // DB 초기화
    async function initDB() {
      const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
      db = new SQL.Database();
      db.run("CREATE TABLE IF NOT EXISTS board (page INTEGER, name TEXT, col INTEGER, value TEXT)");
      document.getElementById("btnSave").disabled = false;
      document.getElementById("btnLoad").disabled = false;
    }

    // 저장
    function saveSQLite() {
      db.run("DELETE FROM board");
      document.querySelectorAll('table').forEach((table, pageIdx) => {
        if (pageIdx === 0) return; // 첫 번째(메인시트) 제외
        table.querySelectorAll('tbody tr').forEach((tr) => {
          const firstTd = tr.querySelector('td:first-child');
          if (!firstTd) return;
          const name = firstTd.textContent.trim();
          tr.querySelectorAll('td select').forEach((sel, colIdx) => {
            db.run("INSERT INTO board VALUES (?, ?, ?, ?)", [pageIdx, name, colIdx, sel.value]);
          });
        });
      });
      const binaryArray = db.export();
      const blob = new Blob([binaryArray], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "board.sqlite";
      a.click();
      URL.revokeObjectURL(url);
      alert("SQLite 저장 완료!");
    }

    // 불러오기
    function loadSQLite(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const Uints = new Uint8Array(reader.result);
        db = new SQL.Database(Uints);
        const res = db.exec("SELECT * FROM board");
        if (res.length > 0) {
          const rows = res[0].values;
          rows.forEach(([page, name, col, value]) => {
            const table = document.getElementById("page" + page);
            if (!table) return;
            const tr = Array.from(table.querySelectorAll('tbody tr')).find(r => r.querySelector('td:first-child')?.textContent.trim() === name);
            if (tr) {
              const sel = tr.querySelectorAll('td select')[col];
              if (sel) sel.value = value;
            }
          });
        }
        alert("SQLite 불러오기 완료!");
      };
      reader.readAsArrayBuffer(file);
    }

    // 필터 적용 (예시: 선택이 O인 행만 표시)
    function applyFilters() {
      document.querySelectorAll('table').forEach(table => {
        table.querySelectorAll('tbody tr').forEach(tr => {
          const sel = tr.querySelector('td select');
          if (sel && sel.value === "O") {
            tr.style.display = "";
          } else {
            tr.style.display = "none";
          }
        });
      });
    }

    // 페이지 로드 시 DB 준비
    window.addEventListener("DOMContentLoaded", initDB);
  </script>
</body>
</html>
