  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>트릭컬 보드</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <style>
    .page { background-color: black; color: white; padding: 20px; }
    .page table { background-color: white; color: black; }
    .active { display: table; }
    button { margin: 5px; padding: 8px 12px; }
    #pageIndicator { text-align: center; font-size: 24px; margin: 15px 15px; font-weight: bold; }
    table th, table td { text-align: center; vertical-align: middle; }
    select { font-size: 50px; height: 60px; width: 100%; box-sizing: border-box; }
    input[type="text"] { font-size: 15px; height: 60px; width: 100%; box-sizing: border-box; text-align: center; line-height: 60px; }
    table td img { width: 100%; height: 100%; display: block; object-fit: cover; }
    #page2 th:nth-child(1), #page2 td:nth-child(1) { width: 5%; aspect-ratio: 1 / 1; }
    #page2 th:nth-child(2), #page2 td:nth-child(2) { width: 5%; aspect-ratio: 1 / 1; }
    #page2 th:nth-child(n+3), #page2 td:nth-child(n+3) { width: 5%; aspect-ratio: 1 / 1; }
    #page3 th:nth-child(1), #page3 td:nth-child(1) { width: 5%; aspect-ratio: 1 / 1; }
    #page3 th:nth-child(2), #page3 td:nth-child(2) { width: 5%; aspect-ratio: 1 / 1; }
    #page3 th:nth-child(n+3), #page3 td:nth-child(n+3) { width: 5%; aspect-ratio: 1 / 1; }
    #page4 th:nth-child(1), #page4 td:nth-child(1) { width: 5%; aspect-ratio: 1 / 1; }
    #page4 th:nth-child(2), #page4 td:nth-child(2) { width: 5%; aspect-ratio: 1 / 1; }
    #page4 th:nth-child(n+3), #page4 td:nth-child(n+3) { width: 5%; aspect-ratio: 1 / 1; }
    #page5 th:nth-child(1), #page5 td:nth-child(1) { width: 5%; aspect-ratio: 1 / 1; }
    #page5 th:nth-child(2), #page5 td:nth-child(2) { width: 5%; aspect-ratio: 1 / 1; }
    #page5 th:nth-child(n+3), #page5 td:nth-child(n+3) { width: 7%; }
  </style>
</head>
<body>
  <div>
    <button onclick="showPage(1)">메인</button>
    <button onclick="showPage(2)">1관</button>
    <button onclick="showPage(3)">2관</button>
    <button onclick="showPage(4)">3관</button>
    <button onclick="showPage(5)">체크리스트</button>
    <button id="btnSave" onclick="saveSQLite()" disabled>저장</button>
    <input type="file" id="fileInput" style="display:none" onchange="loadSQLite(event)">
    <button id="btnLoad" onclick="document.getElementById('fileInput').click()" disabled>불러오기</button>
    <span id="pageIndicator">현재 페이지: 메인시트</span>
  </div>

  <!-- 페이지 1 -->
  <table id="page1" class="page active"></table>

  <!-- 페이지 2 -->
  <table id="page2" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 52%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>공격력</th><th>치명타</th><th>치명피해</th>
        <th>치피저</th><th>HP</th><th>치저</th><th>마방</th><th>물방</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란" ></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td>-</td>
        <td>-</td>
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스" ></td>
        <td>-</td>
        <td><select><option>X</option><option>O</option></select></td>
        <td>-</td>
        <td><select><option>X</option><option>O</option></select></td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
      </tr>
    </tbody>
  </table>
  
  <!-- 페이지 3 -->
  <table id="page3" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 52%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>공격력</th><th>치명타</th><th>치명피해</th>
        <th>치피저</th><th>HP</th><th>치저</th><th>마방</th><th>물방</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
    </tbody>
  </table>
  
  <!-- 페이지 4 -->
  <table id="page4" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 52%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>공격력</th><th>치명타</th><th>치명피해</th>
        <th>치피저</th><th>HP</th><th>치저</th><th>마방</th><th>물방</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
    </tbody>
  </table>

  <!-- 페이지 5 -->
  <table id="page5" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 26%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>성급</th><th>장비랭크</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">-</option><option>O</option><option>X</option><option>1성</option><option>2성</option><option>3성</option><option>4성</option><option>5성</option>
        <option>어사2성</option><option>어사3성</option></select></td>
        <td><select><option value="">-</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option></select></td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비" ></td>
        <td><select><option>3성</option><option>4성</option><option>5성</option><option>어사2성</option><option>어사3성</option></select></td>
        <td><select><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option></select></td>
      </tr>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란" ></td>
        <td><select><option>3성</option><option>4성</option><option>5성</option><option>어사2성</option><option>어사3성</option></select></td>
        <td><select><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option></select></td>
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스" ></td>
        <td><select><option>3성</option><option>4성</option><option>5성</option><option>어사2성</option><option>어사3성</option></select></td>
        <td><select><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option>
        <option>7</option><option>8</option><option>9</option><option>10</option><option>11</option></select></td>
      </tr>
    </tbody>
  </table>

  <!-- 페이지 6 -->
  <table id="page6" class="page" border="1" cellpadding="5" cellspacing="0" style="display: none !important;">
    <thead>
      <tr>
        <th>이름</th><th>공백</th><th>속성</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>비비</td>
        <td></td>
        <td>순수</td>
      </tr>
      <tr>
        <td>란</td>
        <td></td>
        <td>순수</td>
      </tr>
      <tr>
        <td>우로스</td>
        <td></td>
        <td>공명</td>
      </tr>
    </tbody>
  </table>
  
  <script>
    let db;
    let SQL; // ✅ 전역 SQL 객체

    // 페이지 전환
    function showPage(num) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page' + num).classList.add('active');

      let indicatorText = "";

      if (num === 1) {
        indicatorText = "메인시트";
      } else if (num === 5) {
        indicatorText = "체크리스트";
      } else {
        indicatorText = (num - 1) + "관";
      }

      document.getElementById('pageIndicator').textContent = "현재 페이지: " + indicatorText;
    }

    // DB 초기화
    async function initDB() {
      SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
      });
      db = new SQL.Database();
      db.run("CREATE TABLE IF NOT EXISTS board (page INTEGER, name TEXT, col INTEGER, value TEXT)");
      document.getElementById("btnSave").disabled = false;
      document.getElementById("btnLoad").disabled = false;
    }

    // 저장
    function saveSQLite() {
      db.run("DELETE FROM board");
      document.querySelectorAll('table').forEach((table) => {
        const pageId = table.id.replace("page", ""); 
        if (pageId === "1" || pageId === "6") return; 
        table.querySelectorAll('tbody tr').forEach((tr) => {
          const firstTd = tr.querySelector('td:first-child');
          if (!firstTd) return;
          const name = firstTd.textContent.trim();
          tr.querySelectorAll('td select').forEach((sel, colIdx) => {
            db.run("INSERT INTO board VALUES (?, ?, ?, ?)", [pageId, name, colIdx, sel.value]);
          });
        });
      });
      const binaryArray = db.export();
      const blob = new Blob([binaryArray], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "board.sqlite";
      a.click();
      URL.revokeObjectURL(url);
      alert("SQLite 저장 완료!");
    }

    // 로드 기능
    function loadSQLite(event) {
      const file = event.target.files[0];
      if (!file) return;

      const MAX_BYTES = 2 * 1024 * 1024; // 2MB
      if (file.size > MAX_BYTES) { alert("파일이 너무 큽니다."); return; }

      const reader = new FileReader();
      reader.onload = () => {
        try {
          const Uints = new Uint8Array(reader.result);
          const testDb = new SQL.Database(Uints);

          const check = testDb.exec("SELECT type, name, sql FROM sqlite_master WHERE type IN ('trigger','view')");
          if (check.length && check[0].values.length > 0) {
            console.warn("거부된 DB의 sqlite_master:", check[0].values);
            alert("이 DB는 트리거나 뷰를 포함하고 있어 로드할 수 없습니다.");
            testDb.close && testDb.close();
            return;
          }

          db = testDb;

          const res = db.exec("SELECT * FROM board");
          if (res.length > 0) {
            const rows = res[0].values;
            rows.forEach(([page, name, col, value]) => {
              const table = document.getElementById("page" + page);
              if (!table) return;
              const tr = Array.from(table.querySelectorAll('tbody tr'))
                .find(r => r.querySelector('td:first-child')?.textContent.trim() === name);
              if (tr) {
                const sel = tr.querySelectorAll('td select')[col];
                if (sel) sel.value = String(value); 
              }
            });
          }
          alert("SQLite 불러오기 완료!");
        } catch (err) {
          console.error(err);
          alert("파일 처리 중 오류가 발생했습니다.");
        }
      };
      reader.readAsArrayBuffer(file);
    }
    
    function applyFilters(table) {
      const filterRow = table.querySelector('.filterRow');
      if (!filterRow) return;

      const filters = Array.from(filterRow.querySelectorAll('input, select'));

      table.querySelectorAll('tbody tr').forEach(tr => {
        let show = true;
        const tds = tr.querySelectorAll('td');

        filters.forEach((filter, fIdx) => {
          if (!show) return;

          const val = filter.value;
          if (!val) return; // "-" 선택 시 전체 보기

          let td;

          if (filter.tagName === 'INPUT') {
            td = tds[0];
          } else if (filter.tagName === 'SELECT') {1
            td = tds[fIdx + 1];
          }

          if (!td) return;

          let cellVal = '';
          if (filter.tagName === 'INPUT') {
            cellVal = td.textContent.trim();
            if (!cellVal.includes(val)) show = false;
          } else if (filter.tagName === 'SELECT') {
            const sel = td.querySelector('select');
            cellVal = sel ? sel.value.trim() : "-";
            if (cellVal !== val) show = false;
          }
        });

        tr.style.display = show ? '' : 'none';
      });
    }
    
    // 페이지 로드 시 DB 준비
    window.addEventListener("DOMContentLoaded", initDB);

    
    // 필터 이벤트 연결
    document.querySelectorAll('.filterRow input, .filterRow select').forEach(filter => {
      filter.addEventListener('input', e => applyFilters(e.target.closest('table')));
      filter.addEventListener('change', e => applyFilters(e.target.closest('table')));
    });

    document.querySelectorAll("#page6 tbody tr").forEach(tr => {
  const attribute = tr.cells[2].textContent.trim(); // 속성
  const name = tr.cells[0].textContent.trim(); // 이름

  // 속성 색깔 칠하기
  for (let i = 2; i <= 5; i++) {
    const pageRows = document.querySelectorAll(`#page${i} tbody tr`);
    pageRows.forEach(row => {
      const rowName = row.cells[0].textContent.trim();
      if (rowName === name) {
        const colIndex = 0;

        let color = "";
        if (attribute === "순수") color = "#a8e6a3";
        else if (attribute === "공명") color = "";

        if (row.cells[colIndex]) row.cells[colIndex].style.backgroundColor = color;
        if (row.cells[colIndex + 1]) row.cells[colIndex + 1].style.backgroundColor = color;
      }
    });
  }
});
    
  </script>
</body>
</html>
