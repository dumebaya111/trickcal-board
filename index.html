<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>트릭컬 보드</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <style>
    .page { display: none; }
    .active { display: table; }
    button { margin: 5px; padding: 8px 12px; }
    #pageIndicator { text-align: center; font-size: 24px; margin: 15px 15px; font-weight: bold; }
    table th, table td { text-align: center; vertical-align: middle; }
    select, input { font-size: 50px; height: 60px; width: 100%; box-sizing: border-box; }
    img { width: 80px; height: auto; display: block; margin: 0 auto; }
    .filterRow input, .filterRow select { font-size: 30px; height: 50px; }
  </style>
</head>
<body>
  <div id="pageIndicator">현재 페이지: 메인시트</div>

  <div style="text-align:center;">
    <button onclick="showPage(1)">메인시트</button>
    <button onclick="showPage(2)">1관</button>
    <button onclick="showPage(3)">2관</button>
    <button onclick="showPage(4)">3관</button>
    <button id="btnSave" onclick="saveSQLite()" disabled>저장</button>
    <input type="file" id="loadFile" accept=".sqlite" disabled>
    <button id="btnLoad" onclick="loadSQLite()" disabled>불러오기</button>
  </div>
  
  <!-- 페이지 1 -->
  <table id="page1" class="page active"></table>

  <!-- 페이지 2 -->
  <table id="page2" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 50%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>공격력</th><th>치명타</th><th>치명피해</th>
        <th>치피저</th><th>HP</th><th>치저</th><th>마방</th><th>물방</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">전체</option><option>O</option><option>X</option></select></td>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란"></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
      </tr>
      <tr>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비"></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스"></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
        <td><select><option>-</option><option>O</option><option>X</option></select></td>
      </tr>
    </tbody>
  </table>

  <!-- 페이지 3, 4 동일하게 페이지2 구조 + 필터행 추가 -->
  <!-- ... 여기에 페이지3,4 코드 붙여 넣기 ... -->

  <script>
    let db;
    let SQL;

    async function initDB() {
      SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}` });
      db = new SQL.Database();
      db.run("CREATE TABLE IF NOT EXISTS board (page INT, name TEXT, col INT, value TEXT)");

      document.getElementById('btnSave').disabled = false;
      document.getElementById('btnLoad').disabled = false;
      document.getElementById('loadFile').disabled = false;
    }

    function showPage(num) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page' + num).classList.add('active');
      document.getElementById('pageIndicator').textContent = "현재 페이지: " + (num === 1 ? "메인시트" : (num-1) + "관");
    }

    function saveSQLite() {
      db.run("DELETE FROM board");
      document.querySelectorAll('table').forEach((table, pageIdx) => {
        if (pageIdx === 0) return;
        table.querySelectorAll('tbody tr').forEach((tr) => {
          const name = tr.querySelector('td').textContent.trim(); 
          tr.querySelectorAll('td select').forEach((sel, colIdx) => {
            db.run("INSERT INTO board VALUES (?, ?, ?, ?)", [pageIdx + 1, name, colIdx, sel.value]);
          });
        });
      });
      const binaryArray = db.export();
      const blob = new Blob([binaryArray], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "board.sqlite";
      a.click();
      URL.revokeObjectURL(url);
      alert("SQLite 저장 완료!");
    }

    function loadSQLite() {
      const fileInput = document.getElementById('loadFile');
      if (!fileInput.files.length) { alert("파일 선택!"); return; }

      const reader = new FileReader();
      reader.onload = function () {
        try {
          const Uints = new Uint8Array(reader.result);
          const newDB = new SQL.Database(Uints);

          const res = newDB.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='board'");
          if (res.length === 0) { alert("board 테이블이 없습니다!"); return; }

          document.querySelectorAll('table').forEach((table, pageIdx) => {
            if (pageIdx === 0) return;
            table.querySelectorAll('tbody tr').forEach((tr) => {
              const name = tr.querySelector('td').textContent.trim(); 
              tr.querySelectorAll('td select').forEach((sel, colIdx) => {
                const stmt = newDB.prepare("SELECT value FROM board WHERE page=? AND name=? AND col=?");
                stmt.bind([pageIdx + 1, name, colIdx]);
                if (stmt.step()) {
                  const val = stmt.get()[0];
                  if (val) sel.value = val;
                }
                stmt.free();
              });
            });
          });

          db = newDB;
          alert("SQLite 불러오기 완료!");
        } catch (e) {
          console.error(e);
          alert("SQLite 불러오기 실패: " + e.message);
        }
      };
      reader.readAsArrayBuffer(fileInput.files[0]);
    }

    // 필터 함수
    function applyFilters(table) {
      const filters = Array.from(table.querySelectorAll('.filterRow input, .filterRow select'));
      table.querySelectorAll('tbody tr').forEach(tr => {
        let show = true;
        filters.forEach((filter, idx) => {
          if (!show) return;
          const val = filter.value;
          const cell = tr.cells[idx];
          if (!cell) return;
          const cellVal = cell.querySelector('select') ? cell.querySelector('select').value : cell.textContent.trim();
          if (val && val !== cellVal && !cellVal.includes(val)) show = false;
        });
        tr.style.display = show ? '' : 'none';
      });
    }

    // 필터 이벤트 연결
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.filterRow input, .filterRow select').forEach(filter => {
        filter.addEventListener('input', e => applyFilters(e.target.closest('table')));
        filter.addEventListener('change', e => applyFilters(e.target.closest('table')));
      });
    });

    initDB();
  </script>
</body>
</html>
