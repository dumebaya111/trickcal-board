  <!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>트릭컬 보드</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
  <style>
    .page { display: none; }
    .active { display: table; }
    button { margin: 5px; padding: 8px 12px; }
    #pageIndicator { text-align: center; font-size: 24px; margin: 15px 15px; font-weight: bold; }
    table th, table td { text-align: center; vertical-align: middle; }
    select { font-size: 25px; height: 60px; width: 100%; box-sizing: border-box; }
    input[type="text"] { font-size: 30px; height: 60px; width: 100%; box-sizing: border-box; }
    table td img { max-width: 100%; max-height: 80px; height: auto; display: block; margin: 0 auto; object-fit: contain; }
    #page2 th:nth-child(1), #page2 td:nth-child(1) { width: 5%; }
    #page2 th:nth-child(2), #page2 td:nth-child(2) { width: 8%; }
    #page2 th:nth-child(n+3), #page2 td:nth-child(n+3) { width: 5%; }
  </style>
</head>
<body>
  <div>
    <button onclick="showPage(1)">메인시트</button>
    <button onclick="showPage(2)">1관</button>
    <button onclick="showPage(3)">2관</button>
    <button onclick="showPage(4)">3관</button>
    <button id="btnSave" onclick="saveSQLite()" disabled>저장</button>
    <input type="file" id="fileInput" style="display:none" onchange="loadSQLite(event)">
    <button id="btnLoad" onclick="document.getElementById('fileInput').click()" disabled>불러오기</button>
    <span id="pageIndicator">현재 페이지: 메인시트</span>
  </div>

  <!-- 페이지 1 -->
  <table id="page1" class="page active"></table>

  <!-- 페이지 2 -->
  <table id="page2" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 53%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>공격력</th><th>치명타</th><th>치명피해</th>
        <th>치피저</th><th>HP</th><th>치저</th><th>마방</th><th>물방</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
      </tr>
    </thead>
    <tbody>
      <tbody>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td>-
        <td>-
        <td>-
        <td>-
        <td>-
        <td>-
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란" ></td>
        <td>-
        <td>-
        <td>-
        <td>-
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td>-
        <td>-
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스" ></td>
        <td>-
        <td><select><option>X</option><option>O</option></select></td>
        <td>-
        <td><select><option>X</option><option>O</option></select></td>
        <td>-
        <td>-
        <td>-
        <td>-
      </tr>
    </tbody>
  </table>
  
  <!-- 페이지 3 -->
  <table id="page3" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 53%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>공격력</th><th>치명타</th><th>치명피해</th>
        <th>치피저</th><th>HP</th><th>치저</th><th>마방</th><th>물방</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
      </tr>
    </thead>
    <tbody>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
    </tbody>
  </table>
  
  <!-- 페이지 4 -->
  <table id="page4" class="page" border="1" cellpadding="5" cellspacing="0" style="table-layout: fixed; width: 53%;">
    <thead>
      <tr>
        <th>이름</th><th>사진</th><th>공격력</th><th>치명타</th><th>치명피해</th>
        <th>치피저</th><th>HP</th><th>치저</th><th>마방</th><th>물방</th>
      </tr>
      <tr class="filterRow">
        <td><input type="text" placeholder="이름"></td>
        <td></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
        <td><select><option value="">-</option><option>O</option><option>X</option></select></td>
      </tr>
    </thead>
    <tbody>
        <td>비비</td>
        <td><img src="사도/순/비비.png" alt="비비" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>란</td>
        <td><img src="사도/순/란.png" alt="란" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
      <tr>
        <td>우로스</td>
        <td><img src="사도/공명/우로스.png" alt="우로스" ></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
        <td><select><option>X</option><option>O</option></select></td>
      </tr>
    </tbody>
  </table>

  <script>
    let db;
    let SQL; // ✅ 전역 SQL 객체

    // 페이지 전환
    function showPage(num) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page' + num).classList.add('active');
      document.getElementById('pageIndicator').textContent =
        "현재 페이지: " + (num === 1 ? "메인시트" : (num-1) + "관");
    }

    // DB 초기화
    async function initDB() {
      SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
      });
      db = new SQL.Database();
      db.run("CREATE TABLE IF NOT EXISTS board (page INTEGER, name TEXT, col INTEGER, value TEXT)");
      document.getElementById("btnSave").disabled = false;
      document.getElementById("btnLoad").disabled = false;
    }

    // 저장
    function saveSQLite() {
      db.run("DELETE FROM board");
      document.querySelectorAll('table').forEach((table) => {
        const pageId = table.id.replace("page", ""); // ✅ 실제 페이지 번호 추출
        if (pageId === "1") return; // 메인시트 제외
        table.querySelectorAll('tbody tr').forEach((tr) => {
          const firstTd = tr.querySelector('td:first-child');
          if (!firstTd) return;
          const name = firstTd.textContent.trim();
          tr.querySelectorAll('td select').forEach((sel, colIdx) => {
            db.run("INSERT INTO board VALUES (?, ?, ?, ?)", [pageId, name, colIdx, sel.value]);
          });
        });
      });
      const binaryArray = db.export();
      const blob = new Blob([binaryArray], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = "board.sqlite";
      a.click();
      URL.revokeObjectURL(url);
      alert("SQLite 저장 완료!");
    }
  
    // 불러오기
    function loadSQLite(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const Uints = new Uint8Array(reader.result);
        db = new SQL.Database(Uints); // ✅ 여기서 SQL이 전역에 있어야 함
        const res = db.exec("SELECT * FROM board");
        if (res.length > 0) {
          const rows = res[0].values;
          rows.forEach(([page, name, col, value]) => {
            const table = document.getElementById("page" + page);
            if (!table) return;
            const tr = Array.from(table.querySelectorAll('tbody tr'))
              .find(r => r.querySelector('td:first-child')?.textContent.trim() === name);
            if (tr) {
              const sel = tr.querySelectorAll('td select')[col];
              if (sel) sel.value = value;
            }
          });
        }
        alert("SQLite 불러오기 완료!");
      };
      reader.readAsArrayBuffer(file);
    }

    window.addEventListener("DOMContentLoaded", initDB);

    function applyFilters(table) {
      const filterRow = table.querySelector('.filterRow');
      if (!filterRow) return;

      // 필터(input/select)만 가져오기
      const filters = Array.from(filterRow.querySelectorAll('input, select'));

      table.querySelectorAll('tbody tr').forEach(tr => {
        let show = true;
        const tds = tr.querySelectorAll('td');

        filters.forEach((filter, fIdx) => {
          if (!show) return;

          const val = filter.value;
          if (!val) return; // "-" 선택 시 전체 보기

          let td;

          if (filter.tagName === 'INPUT') {
            // 이름 필터 → 첫 번째 td
            td = tds[0];
          } else if (filter.tagName === 'SELECT') {
            // select 필터 → 데이터 열 인덱스 보정
            // 사진 칸 때문에 +1
            td = tds[fIdx + 1];
          }

          if (!td) return;

          let cellVal = '';
          if (filter.tagName === 'INPUT') {
            cellVal = td.textContent.trim();
            if (!cellVal.includes(val)) show = false;
          } else if (filter.tagName === 'SELECT') {
            const sel = td.querySelector('select');
            cellVal = sel ? sel.value.trim() : "-";
            if (cellVal !== val) show = false;
          }
        });

        tr.style.display = show ? '' : 'none';
      });
    }
    
    // 페이지 로드 시 DB 준비
    window.addEventListener("DOMContentLoaded", initDB);

    
    // 필터 이벤트 연결
    document.querySelectorAll('.filterRow input, .filterRow select').forEach(filter => {
      filter.addEventListener('input', e => applyFilters(e.target.closest('table')));
      filter.addEventListener('change', e => applyFilters(e.target.closest('table')));
    });
    
  </script>
</body>
</html>
